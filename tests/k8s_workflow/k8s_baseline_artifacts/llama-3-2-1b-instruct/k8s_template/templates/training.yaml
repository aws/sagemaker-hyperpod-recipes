{{ $config := .Values.trainingConfig }}
{{- if $config.useHyperPodPytorchJob }}
apiVersion: sagemaker.amazonaws.com/v1
kind: HyperPodPyTorchJob
{{- else }}
apiVersion: kubeflow.org/v1
kind: PyTorchJob
{{- end }}
metadata:
  name: {{ $config.jobName }}
  namespace: {{ $config.namespace }}
  {{- if $config.annotations }}
  annotations:
    {{- range $key, $value := $config.annotations }}
    {{ $key | quote }}: {{ $value | quote }}
    {{- end }}
  {{- end }}
  labels:
    app: {{ $config.jobName }}
    {{- if $config.queue_name }}
    kueue.x-k8s.io/queue-name: {{ $config.queue_name }}
    {{- end }}
    {{- if $config.customLabels }}
    {{- range $key, $value := $config.customLabels }}
    {{ $key | quote }}: {{ $value | quote }}
    {{- end}}
    {{- end }}
spec:
  {{- if $config.elastic_policy.is_elastic }}
  elasticPolicy:
    minReplicas: {{ $config.elastic_policy.min_nodes }}
    maxReplicas: {{ $config.elastic_policy.max_nodes }}
    replicaIncrementStep: {{ $config.elastic_policy.replica_increment_step }}
    scalingTimeoutInSeconds: {{ $config.elastic_policy.scaling_timeout }}
    gracefulShutdownTimeoutInSeconds: {{ $config.elastic_policy.graceful_shutdown_timeout }}
    faultyScaleDownTimeoutInSeconds: {{ $config.elastic_policy.faulty_timeout }}
    replicaDiscreteValues:
    {{- range $config.elastic_policy.replica_space }}
    - {{ . }}
    {{- end }}
  {{- end }}
  {{- if $config.useHyperPodPytorchJob }}
  nprocPerNode: "{{ $config.ntasksPerNode }}"
  {{- if $config.cleanPodPolicy }}
  runPolicy:
    cleanPodPolicy: {{ $config.cleanPodPolicy }}
  {{- end }}
  replicaSpecs:
    - name: '{{ $config.nodes }}-nodes'
      replicas: {{ $config.nodes }}
      {{- if $config.elastic_policy.is_elastic }}
      maxReplicas: {{ $config.elastic_policy.max_nodes }}
      {{- end }}
      template:
        {{- template "podTemplate" . }}
  {{- else }}
  {{- if $config.cleanPodPolicy }}
  runPolicy:
    cleanPodPolicy: {{ $config.cleanPodPolicy }}
  {{- end }}
  pytorchReplicaSpecs:
    Worker:
      replicas: {{ $config.nodes }}
      restartPolicy: {{ $config.restartPolicy }}
      template:
        {{- template "podTemplate" . }}
  {{- end }}

{{- define "podTemplate" }}
{{- $config := .Values.trainingConfig }}
        {{- if $config.customLabels }}
        metadata:
          labels:
            {{- range $key, $value := $config.customLabels }}
            {{ $key | quote }}: {{ $value | quote }}
            {{- end }}
        {{- end }}
        spec:
          {{- if $config.hostNetwork }}
          hostNetwork: {{ $config.hostNetwork }}
          {{- end }}
          {{- if $config.nodeSelector }}
          nodeSelector:
            {{- range $key, $value := $config.nodeSelector }}
            {{ $key | quote }}: {{ $value | quote }}
            {{- end }}
          {{- else if $config.instanceType }}
          nodeSelector:
            beta.kubernetes.io/instance-type: ml.{{ $config.instanceType }}
          {{- end }}
{{- end }}

          {{- if $config.priorityClassName }}
          priorityClassName: {{ $config.priorityClassName }}
          {{- end}}
          {{- if $config.serviceAccountName }}
          serviceAccountName: {{ $config.serviceAccountName }}
          {{- end }}
          containers:
          - name: pytorch
            image: {{ .Values.image.trainingImage }}
            env:
              {{- range $key, $value := $config.envVars }}
              - name: {{ $key }}
                value: {{ $value | quote }}
              {{- end}}
              # New environmental variables for the script
              - name: GIT_REPO_URL
                value: {{ $config.git.repo_url_or_path | quote }}
              - name: GIT_BRANCH
                value: {{ $config.git.branch | quote }}
              - name: GIT_COMMIT
                value: {{ $config.git.commit | quote }}
              - name: GIT_UPDATE_ADAPTER
                value: {{ $config.git.update_adapter | quote }}
              - name: NODES
                value: {{ $config.nodes | quote }}
              - name: NTASKS_PER_NODE
                value: {{ $config.ntasksPerNode | quote }}
              {{- if not $config.queue_name }}
              - name: JOB_NAME
                value: {{ $config.jobName | quote }}
              {{- end }}
              - name: SCRIPT_PATH
                value: {{ $config.scriptPath | quote }}
              - name: SCRIPT_ARGS
                value: {{ $config.scriptArgs | quote }}
              - name: PRE_SCRIPT_COMMANDS
                value: {{ join ";" $config.pre_script | quote }}
              - name: POST_SCRIPT_COMMANDS
                value: {{ join ";" $config.post_script | quote }}
              {{- if $config.useHyperPodPytorchJob }}
              - name: USE_HYPERPODRUN
                value: "true"
              {{- end }}
            command:
            - /bin/bash
            - -c
            {{- if eq $config.device "trainium" }}
            - "/opt/bin/scripts/train-script-trn.sh 2>&1 | tee /data/training.log"
            {{- else }}
            - "/opt/bin/scripts/train-script-gpu.sh 2>&1 | tee /data/training.log"
            {{- end }}
            imagePullPolicy: {{ .Values.image.pullPolicy }}
            securityContext:
              privileged: true
            {{- if or (eq $config.device "gpu") (eq $config.device "trainium") (gt (int $config.numEFADevices) 0 ) $config.hugepages $config.memory }}
            resources:
              requests:
                {{- if eq $config.device "gpu" }}
                nvidia.com/gpu: {{ $config.ntasksPerNode }}
                {{- end }}
                {{- if eq $config.device "trainium" }}
                aws.amazon.com/neurondevice: {{ $config.numNeuronDevices }}
                {{- end }}
                {{- if gt (int $config.numEFADevices) 0 }}
                vpc.amazonaws.com/efa: {{ $config.numEFADevices }}
                {{- end }}
                {{- if $config.hugepages }}
                hugepages-2Mi: {{ $config.hugepages }}
                {{- end }}
                {{- if $config.memory }}
                memory: {{ $config.memory }}
                {{- end }}
              limits:
                {{- if eq $config.device "gpu" }}
                nvidia.com/gpu: {{ $config.ntasksPerNode }}
                {{- end }}
                {{- if eq $config.device "trainium" }}
                aws.amazon.com/neurondevice: {{ $config.numNeuronDevices }}
                {{- end }}
                {{- if gt (int $config.numEFADevices) 0 }}
                vpc.amazonaws.com/efa: {{ $config.numEFADevices }}
                {{- end }}
                {{- if $config.hugepages }}
                hugepages-2Mi: {{ $config.hugepages }}
                {{- end }}
            {{- end }}
            volumeMounts:
            {{- if $config.persistentVolumeClaims }}
            {{- range $config.persistentVolumeClaims }}
            - mountPath: {{ .mountPath }}
              name: {{ .claimName }}-volume
            {{- end }}
            {{- end }}
            {{- if $config.volumes }}
            {{- range $config.volumes }}
            - name: {{ .volumeName }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- end }}
            {{- if not $config.customScript }}
            - mountPath: /config
              name: training-config
            {{- end }}
            - mountPath: /dev/shm
              name: shm
            - mountPath: /var/log/aws/clusters
              name: aws-clusters-logs
              readOnly: true

          {{- if (or $config.labelSelector.required $config.labelSelector.preferred) }}
          affinity:
            nodeAffinity:
            {{- if $config.labelSelector.required }}
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                    {{- range $key, $values := $config.labelSelector.required }}
                    - key: {{ $key | quote }}
                      operator: In
                      values:
                        {{- range $values }}
                        - {{ . | quote }}
                        {{- end}}
                    {{- end }}
            {{- end }}

            {{- if $config.labelSelector.preferred }}
              {{- $index := 0 }}
              preferredDuringSchedulingIgnoredDuringExecution:
                {{- range $key, $values := $config.labelSelector.preferred }}
                - weight: {{ index $config.labelSelector.weights $index }}
                  preference:
                    matchExpressions:
                      - key: {{ $key | quote }}
                        operator: In
                        values:
                          {{- range $values }}
                          - {{ . | quote }}
                          {{- end }}
                {{- $index = add $index 1 }}
                {{- end }}
            {{- end }}
          {{- end }}

          volumes:
          {{- if $config.persistentVolumeClaims }}
          {{- range $config.persistentVolumeClaims }}
          - name: {{ .claimName }}-volume
            persistentVolumeClaim:
              claimName: {{ .claimName }}
          {{- end }}
          {{- end }}
          {{- if $config.volumes }}
          {{- range $config.volumes }}
            - name: {{ .volumeName }}
              hostPath:
                path: {{ .hostPath }}
                type: Directory
          {{- end }}
          {{- end }}
          {{- if not $config.customScript }}
          - configMap:
              name: training-config-{{ $config.jobName }}
            name: training-config
          {{- end }}
          - name: shm
            hostPath:
              path: /dev/shm
              type: Directory
          - name: aws-clusters-logs
            hostPath:
              path: /var/log/aws/clusters
              type: DirectoryOrCreate
