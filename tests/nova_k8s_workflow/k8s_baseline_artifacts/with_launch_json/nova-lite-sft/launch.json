{
  "training-config.yaml": "---\n# Source: sagemaker-training/templates/training-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: training-config-{{name}}\ndata:\n  config.yaml: |-\n    run:\n      name: '{{name}}'\n      model_type: amazon.nova-micro-v1:0:128k\n      model_name_or_path: nova-micro/prod\n      replicas: '{{replicas}}'\n      data_s3_path: '{{data_s3_path}}'\n      output_s3_path: '{{output_s3_path}}'\n      mlflow_tracking_uri: '{{mlflow_tracking_uri}}'\n      mlflow_experiment_name: '{{mlflow_experiment_name}}'\n      mlflow_run_name: '{{mlflow_run_name}}'\n    training_config:\n      max_length: 16384\n      global_batch_size: '{{global_batch_size}}'\n      trainer:\n        max_epochs: '{{max_epochs}}'\n      model:\n        hidden_dropout: 0.0\n        attention_dropout: 0.0\n        ffn_dropout: 0.0\n        optim:\n          lr: '{{learning_rate}}'\n          name: distributed_fused_adam\n          adam_w_mode: true\n          eps: 1.0e-08\n          weight_decay: 0.01\n          betas:\n          - 0.9\n          - 0.999\n          sched:\n            warmup_steps: 10\n            constant_steps: 0\n            min_lr: 1.0e-06\n        dpo_cfg:\n          beta: '{{adam_beta}}'\n        peft:\n          peft_scheme: lora\n          lora_tuning:\n            loraplus_lr_ratio: '{{learning_rate_ratio}}'\n            alpha: '{{lora_alpha}}'\n            adapter_dropout: 0.01\n",
  "training.yaml": "---\n# Source: sagemaker-training/templates/training.yaml\napiVersion: kubeflow.org/v1\nkind: PyTorchJob\nmetadata:\n  name: {{name}}\n  namespace: {{namespace}}\n  annotations:\n    \"annotation_key_1\": \"annotation-value-1\"\n  labels:\n    app: {{name}}\n    \"placeholder\": \"custom_labels\"\nspec:\n  pytorchReplicaSpecs:\n    Master:\n      replicas: 1\n      restartPolicy: OnFailure\n      template:\n        metadata:\n          labels:\n            \"placeholder\": \"custom_labels\"\n        spec:\n          tolerations:\n            - key: \"sagemaker.amazonaws.com/RestrictedNode\"\n              operator: \"Equal\"\n              value: \"Worker\"\n              effect: \"NoSchedule\"\n          priorityClassName: test_pc_name\n          serviceAccountName: placeholder_service_account_name\n          initContainers:\n            - name: init-container\n              image: {{init_container_image}}\n              imagePullPolicy: Always\n              volumeMounts:\n              - name: fsx-path-init\n                mountPath: /sagemaker/fsx/init\n              - mountPath: /config\n                name: training-config\n              - mountPath: /var/log/aws/clusters\n                name: logs\n          containers:\n          - name: pytorch\n            image: {{container_image}}\n            env:\n              - name: INSTANCE_TYPE\n                value: \"{{instance_type}}\"\n            imagePullPolicy: Always\n            resources:\n              limits:\n                nvidia.com/gpu: 8\n                vpc.amazonaws.com/efa: 32\n              requests:\n                nvidia.com/gpu: 8\n                vpc.amazonaws.com/efa: 32\n            securityContext:\n              capabilities:\n                add: [ \"IPC_LOCK\" ]\n            volumeMounts:\n            - name: fsx-path-main\n              mountPath: /sagemaker/fsx/main\n            - mountPath: /config\n              name: training-config\n            - mountPath: /dev/shm\n              name: dshm\n            - mountPath: /var/log/aws/clusters\n              name: logs\n            - mountPath: /sagemaker/fsx/output_artifacts\n              name: fsx-path-output-artifacts\n            - name: tmp-storage\n              mountPath: /tmp\n          affinity:\n            nodeAffinity:\n              requiredDuringSchedulingIgnoredDuringExecution:\n                nodeSelectorTerms:\n                  - matchExpressions:\n                    - key: \"example_label_key\"\n                      operator: In\n                      values:\n                        - \"expected-label-value-1\"\n                        - \"expected-label-value-2\"\n                    - key: \"node.kubernetes.io/instance-type\"\n                      operator: In\n                      values:\n                        - \"{{instance_type}}\"\n                    - key: \"sagemaker.amazonaws.com/instance-group-type\"\n                      operator: In\n                      values:\n                        - \"Restricted\"\n          volumes:\n            - name: fsx-path-main\n              hostPath:\n                path: /sagemaker/fsx/main\n                type: DirectoryOrCreate\n            - name: fsx-path-init\n              hostPath:\n                path: /sagemaker/fsx/init\n                type: DirectoryOrCreate\n            - configMap:\n                name: training-config-{{name}}\n              name: training-config\n            - name: dshm\n              emptyDir:\n                medium: Memory\n            - name: logs\n              hostPath:\n                path: /var/log/aws/clusters\n                type: DirectoryOrCreate\n            - name: fsx-path-output-artifacts\n              hostPath:\n                path: /sagemaker/fsx/output_artifacts\n                type: DirectoryOrCreate\n            - name: tmp-storage\n              hostPath:\n                path: /opt/dlami/nvme\n                type: Directory\n    Worker:\n      replicas: {{replicas}}\n      restartPolicy: OnFailure\n      template:\n        metadata:\n          labels:\n            \"placeholder\": \"custom_labels\"\n        spec:\n          tolerations:\n            - key: \"sagemaker.amazonaws.com/RestrictedNode\"\n              operator: \"Equal\"\n              value: \"Worker\"\n              effect: \"NoSchedule\"\n          priorityClassName: test_pc_name\n          serviceAccountName: placeholder_service_account_name\n          initContainers:\n            - name: init-container\n              image: {{init_container_image}}\n              imagePullPolicy: Always\n              volumeMounts:\n              - name: fsx-path-init\n                mountPath: /sagemaker/fsx/init\n              - mountPath: /config\n                name: training-config\n              - mountPath: /var/log/aws/clusters\n                name: logs\n          containers:\n          - name: pytorch\n            image: {{container_image}}\n            env:\n              - name: INSTANCE_TYPE\n                value: \"{{instance_type}}\"\n            imagePullPolicy: Always\n            resources:\n              limits:\n                nvidia.com/gpu: 8\n                vpc.amazonaws.com/efa: 32\n              requests:\n                nvidia.com/gpu: 8\n                vpc.amazonaws.com/efa: 32\n            securityContext:\n              capabilities:\n                add: [ \"IPC_LOCK\" ]\n            volumeMounts:\n            - name: fsx-path-main\n              mountPath: /sagemaker/fsx/main\n            - mountPath: /config\n              name: training-config\n            - mountPath: /dev/shm\n              name: dshm\n            - mountPath: /var/log/aws/clusters\n              name: logs\n            - mountPath: /sagemaker/fsx/output_artifacts\n              name: fsx-path-output-artifacts\n            - name: tmp-storage\n              mountPath: /tmp\n          affinity:\n            nodeAffinity:\n              requiredDuringSchedulingIgnoredDuringExecution:\n                nodeSelectorTerms:\n                  - matchExpressions:\n                    - key: \"example_label_key\"\n                      operator: In\n                      values:\n                        - \"expected-label-value-1\"\n                        - \"expected-label-value-2\"\n                    - key: \"node.kubernetes.io/instance-type\"\n                      operator: In\n                      values:\n                        - \"{{instance_type}}\"\n                    - key: \"sagemaker.amazonaws.com/instance-group-type\"\n                      operator: In\n                      values:\n                        - \"Restricted\"\n          volumes:\n            - name: fsx-path-main\n              hostPath:\n                path: /sagemaker/fsx/main\n                type: DirectoryOrCreate\n            - name: fsx-path-init\n              hostPath:\n                path: /sagemaker/fsx/init\n                type: DirectoryOrCreate\n            - configMap:\n                name: training-config-{{name}}\n              name: training-config\n            - name: dshm\n              emptyDir:\n                medium: Memory\n            - name: logs\n              hostPath:\n                path: /var/log/aws/clusters\n                type: DirectoryOrCreate\n            - name: fsx-path-output-artifacts\n              hostPath:\n                path: /sagemaker/fsx/output_artifacts\n                type: DirectoryOrCreate\n            - name: tmp-storage\n              hostPath:\n                path: /opt/dlami/nvme\n                type: Directory\n",
  "metadata": {
    "Name": "nova_micro_1_0_p5_p4d_gpu_lora_dpo",
    "RecipeFilePath": "recipes/fine-tuning/nova/nova_1_0/nova_micro/DPO/nova_micro_1_0_p5_p4d_gpu_lora_dpo.yaml",
    "DisplayName": "Nova Micro LoRA DPO on GPU",
    "DefaultModelNameOrPath": "nova-micro/prod",
    "nova_model_name": "nova-micro/prod",
    "Hardware": "GPU",
    "InstanceTypes": [
      "ml.p5.48xlarge"
    ],
    "Type": "FineTuning",
    "CustomizationTechnique": "dpo",
    "Peft": "lora",
    "ServerlessMeteringType": "Token-based",
    "InstanceCount": 2,
    "SequenceLength": "16K",
    "Model_ID": "nova-textgeneration-micro",
    "Versions": [
      "1.0.0"
    ],
    "OutputConfig": {
      "SageMakerInferenceRecipeName": "default"
    },
    "HostingConfigs": [
      {
        "InstanceType": "ml.p5.48xlarge",
        "Profile": "Default",
        "EcrAddress": "763104351884.dkr.ecr.us-west-2.amazonaws.com/djl-inference:0.34.0-lmi16.0.0-cu128",
        "Environment": {
          "OPTION_ENABLE_LORA": "true",
          "OPTION_MAX_LORAS": "8",
          "OPTION_MAX_CPU_LORAS": "64",
          "OPTION_TENSOR_PARALLEL_DEGREE": "8",
          "OPTION_ROLLING_BATCH": "disable",
          "OPTION_MAX_ROLLING_BATCH_SIZE": "1",
          "OPTION_ASYNC_MODE": "true",
          "OPTION_ENTRYPOINT": "djl_python.lmi_vllm.vllm_async_service",
          "SAGEMAKER_MAX_NUMBER_OF_ADAPTERS_IN_MEMORY": "128",
          "SAGEMAKER_ENABLE_LOAD_AWARE": "1"
        },
        "ComputeResourceRequirements": {
          "MinMemoryRequiredInMb": 1024000,
          "NumberOfCpuCoresRequired": 100,
          "NumberOfAcceleratorDevicesRequired": 8
        }
      }
    ]
  },
  "recipe_override_parameters": {
    "replicas": {
      "type": "integer",
      "required": true,
      "enum": [
        2,
        4,
        8
      ],
      "default": 2
    },
    "name": {
      "type": "string",
      "required": true,
      "default": "nova-lite-sft"
    },
    "data_s3_path": {
      "type": "string",
      "required": true,
      "default": ""
    },
    "output_s3_path": {
      "type": "string",
      "required": true,
      "default": ""
    },
    "global_batch_size": {
      "type": "integer",
      "required": true,
      "enum": [
        16,
        32,
        64
      ],
      "default": 64
    },
    "max_epochs": {
      "type": "integer",
      "required": true,
      "min": 1,
      "max": 30,
      "default": 2
    },
    "learning_rate": {
      "type": "float",
      "required": true,
      "min": 0,
      "max": 1,
      "default": 1e-05
    },
    "adam_beta": {
      "type": "float",
      "required": false,
      "min": 0.001,
      "max": 0.1,
      "default": 0.1
    },
    "lora_alpha": {
      "type": "integer",
      "required": false,
      "enum": [
        32,
        64,
        96,
        128,
        160,
        192
      ],
      "default": 64
    },
    "learning_rate_ratio": {
      "type": "float",
      "required": false,
      "min": 1.0,
      "max": 70.0,
      "default": 20.0
    },
    "namespace": {
      "type": "string",
      "required": true,
      "default": "kubeflow"
    },
    "max_context_length": {
      "type": "integer",
      "required": true,
      "min": 1,
      "max": 131072,
      "default": 8192
    },
    "mlflow_tracking_uri": {
      "type": "string",
      "required": false,
      "default": ""
    },
    "mlflow_experiment_name": {
      "type": "string",
      "required": false,
      "default": "my-lora-experiment"
    },
    "mlflow_run_name": {
      "type": "string",
      "required": false,
      "default": "my-lora-run"
    },
    "instance_type": {
      "type": "string",
      "required": false,
      "enum": [
        "ml.p5.48xlarge"
      ],
      "default": "ml.p5.48xlarge"
    }
  },
  "regional_parameters": {
    "hp_eks_regional_ecr_uri": {
      "prod": {
        "us-east-1": "708977205387.dkr.ecr.us-east-1.amazonaws.com/nova-fine-tune-repo:SM-HP-DPO-latest",
        "us-west-2": "176779409107.dkr.ecr.us-west-2.amazonaws.com/nova-fine-tune-repo:SM-HP-DPO-latest"
      },
      "gamma": {
        "us-east-1": "900867814919.dkr.ecr.us-east-1.amazonaws.com/nova-fine-tune-repo:SM-HP-DPO-latest"
      }
    },
    "init_container_image": {
      "prod": {
        "us-east-1": "708977205387.dkr.ecr.us-east-1.amazonaws.com/init-container-repo:latest",
        "eu-west-2": "470633809225.dkr.ecr.eu-west-2.amazonaws.com/init-container-repo:latest",
        "us-west-2": "176779409107.dkr.ecr.us-west-2.amazonaws.com/init-container-repo:latest"
      },
      "gamma": {
        "us-east-1": "900867814919.dkr.ecr.us-east-1.amazonaws.com/init-container-repo:latest"
      }
    },
    "smtj_regional_ecr_uri": {
      "prod": {
        "us-east-1": "708977205387.dkr.ecr.us-east-1.amazonaws.com/nova-fine-tune-repo:SM-TJ-DPO-latest",
        "us-west-2": "176779409107.dkr.ecr.us-west-2.amazonaws.com/nova-fine-tune-repo:SM-TJ-DPO-latest"
      },
      "gamma": {
        "us-east-1": "900867814919.dkr.ecr.us-east-1.amazonaws.com/nova-fine-tune-repo:SM-TJ-DPO-latest"
      }
    }
  },
  "training_recipe.json": {
    "recipes": {
      "run": {
        "name": "my-lora-run",
        "model_type": "amazon.nova-micro-v1:0:128k",
        "model_name_or_path": "nova-micro/prod",
        "replicas": 2,
        "data_s3_path": "",
        "output_s3_path": "",
        "mlflow_tracking_uri": "",
        "mlflow_experiment_name": "my-lora-experiment",
        "mlflow_run_name": "my-lora-run"
      },
      "training_config": {
        "max_length": 16384,
        "global_batch_size": 64,
        "trainer": {
          "max_epochs": 2
        },
        "model": {
          "hidden_dropout": 0.0,
          "attention_dropout": 0.0,
          "ffn_dropout": 0.0,
          "optim": {
            "lr": 1e-05,
            "name": "distributed_fused_adam",
            "adam_w_mode": true,
            "eps": 1e-08,
            "weight_decay": 0.01,
            "betas": [
              0.9,
              0.999
            ],
            "sched": {
              "warmup_steps": 10,
              "constant_steps": 0,
              "min_lr": 1e-06
            }
          },
          "dpo_cfg": {
            "beta": 0.1
          },
          "peft": {
            "peft_scheme": "lora",
            "lora_tuning": {
              "loraplus_lr_ratio": 20.0,
              "alpha": 64,
              "adapter_dropout": 0.01
            }
          }
        }
      }
    }
  }
}
